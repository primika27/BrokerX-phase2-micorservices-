@startuml uc02_verification_otp_jwt
title UC02b - VÃ©rification OTP avec JWT (Microservices)

actor User
participant "Gateway Service" as Gateway
participant "Auth Controller (AuthService)" as Controller
participant "Auth Service" as Service
database "Auth DB" as AuthDB
collections "OTP Store (Map)" as OtpStore
participant "JWT Service" as JwtService

User -> Gateway : POST /auth/verify-otp
Gateway -> Controller : verifyOtp(email, otp)
Controller -> Service : validateOtp(email, otp)
Service -> AuthDB : findByEmail(email)
AuthDB --> Service : UserCredential

alt Utilisateur trouvÃ©
    Service -> OtpStore : get(user.id)
    OtpStore --> Service : OTP

    alt OTP valide
        Service -> JwtService : generateToken({role:CLIENT}, email)
        JwtService --> Service : JWT token
        Service -> OtpStore : remove(user.id)
        Service --> Controller : JWT token
        Controller --> Gateway : 200 OK + JWT token
        Gateway --> User : Login success + token

    else OTP invalide
        Service --> Controller : null
        Controller --> Gateway : 400 Bad Request
        Gateway --> User : OTP invalide
    end

else Utilisateur introuvable
    Service --> Controller : null
    Controller --> Gateway : 404 Not Found
    Gateway --> User : Utilisateur introuvable
end

@enduml
